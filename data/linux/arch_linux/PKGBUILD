# Maintainer: Fincer <fincer89 at hotmail dot com>

pkgname=openra-bleed-tibsunra2
pkgver=r22238.0479b7f
pkgrel=1
pkgdesc="An open-source implementation of the Red Alert engine using .NET/mono and OpenGL (git version)"
arch=("any")
url="http://openra.net"
license=("GPL3")
depends=("mono" "ttf-dejavu" "openal" "libgl" "freetype2" "sdl2" "lua51" "hicolor-icon-theme" "desktop-file-utils" "xdg-utils")
makedepends=("git")
provides=("openra")
conflicts=("openra-git" "openra")
install=openra-bleed-tibsunra2.install
source=("$pkgname-src::git+https://github.com/OpenRA/OpenRA.git#branch=bleed"
"git://github.com/OpenRA/ra2.git"
sha1sums=('SKIP'
          'SKIP'
          '2e67a7f84d78d7b9ce8981ebb578c7b744406406'
          '412fb02c061918c1a997359713427fa357340a91'
          '5d73aedf0b3f6736981c727646c122d3c75ea27b')

pkgver() {
    cd "$srcdir/$pkgname-src"
    printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}
    
build() {

# Move Red Alert 2 Github files to the right place:
    cd "$srcdir/ra2"
    mv ./OpenRA.Mods.RA2 "$srcdir/$pkgname-src/"
    mkdir -p "$srcdir/$pkgname-src/mods/ra2/"
    mv ./* "$srcdir/$pkgname-src/mods/ra2/"

# Patch OpenRA core files for Tiberian Sun & Red Alert 2
    cd "$srcdir/$pkgname-src"
    for i in $srcdir/*.patch; do patch -Np1 < $i; done

    mkdir $srcdir/$pkgname-src/mods/ra2/bits/{vehicles,themes}

# Get Red Alert 2 GIT version number
    ra2_version=git-$(git ls-remote https://github.com/OpenRA/ra2.git | head -1 | sed "s/HEAD//" | sed 's/^\(.\{7\}\).*/\1/')
    sed -i "s/Version: {DEV_VERSION}/Version: $ra2_version/g" $srcdir/$pkgname-src/mods/ra2/mod.yaml
    sed -i "s/maps\/ra2\/{DEV_VERSION}/maps\/ra2\/$ra2_version/g" $srcdir/$pkgname-src/mods/ra2/mod.yaml
    
    cd "$srcdir/$pkgname-src"
    make version
    make dependencies
    make all [DEBUG=false]
}

package() {
    cd "$srcdir/$pkgname-src"
    make prefix=/usr DESTDIR="$pkgdir" install-all
    make prefix=/usr DESTDIR="$pkgdir" install-linux-shortcuts
}
